<!DOCTYPE html>
<html lang="vi">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lấy lại mật khẩu</title>
    <link rel="stylesheet" href="{% static 'css/forgot_password.css' %}">
</head>
<body>
    <div class="container">
        <div class="login-card">
            <div class="login-content">
                <h2>Lấy lại mật khẩu</h2>
                <p>Vui lòng nhập email của bạn để nhận liên kết đặt lại mật khẩu.</p>
                <form method="post" action="{% url 'forgot_password' %}" id="forgotPasswordForm">
                    {% csrf_token %}
                    <!-- Ô nhập email -->
                    <div class="form-group" id="emailField">
                        <input type="email" id="email" name="email" placeholder="Nhập email của bạn" required oninput="validateEmail()">
                        <span id="emailError" style="color: red; font-size: 0.9em; display: none;">Vui lòng nhập đúng định dạng email.</span>
                    </div>
                    <button type="button" class="login-btn" id="sendButton" onclick="showOtpField()" disabled>Gửi yêu cầu</button>

                    <!-- Ô nhập mã OTP (ẩn mặc định) -->
                    <div class="form-group" id="otpField" style="display: none;">
                        <input type="text" id="otp" name="otp" placeholder="Nhập mã OTP" required>
                        <span id="countdown" style="display: block; margin-top: 10px; color: red;"></span>
                    </div>

                    <!-- Nút Gửi lại mã OTP và Xác nhận mã OTP (ẩn mặc định) -->
                    <div class="form-group" id="otpButtons" style="display: none;">
                        <button type="button" class="resend-btn" onclick="resendOtp()">Gửi lại mã OTP</button>
                        <button type="submit" class="confirm-btn">Xác nhận mã OTP</button>
                    </div>
                </form>
                <p class="back-to-login">
                    <a href="{% url 'login' %}">Quay lại trang đăng nhập</a>
                </p>  
                <script>
                    let countdown = 60; // Biến toàn cục để lưu thời gian đếm ngược
                    let timer; // Biến toàn cục để lưu bộ đếm ngược

                    function showOtpField() {
                        // Ẩn ô nhập email và nút "Gửi yêu cầu"
                        document.getElementById('emailField').style.display = 'none';
                        document.getElementById('sendButton').style.display = 'none';

                        // Hiển thị ô nhập mã OTP và hai nút
                        document.getElementById('otpField').style.display = 'block';
                        document.getElementById('otpButtons').style.display = 'flex';

                        // Bắt đầu đếm ngược
                        startCountdown();
                    }

                    function startCountdown() {
                        const countdownElement = document.getElementById('countdown');
                        const confirmButton = document.querySelector('.confirm-btn');

                        // Reset thời gian và vô hiệu hóa nút "Xác nhận mã OTP"
                        countdown = 60;
                        confirmButton.disabled = false;

                        // Xóa bộ đếm ngược trước đó (nếu có)
                        clearInterval(timer);

                        // Bắt đầu bộ đếm ngược
                        timer = setInterval(() => {
                            countdown--;
                            countdownElement.textContent = `Thời gian còn lại: ${countdown} giây`;

                            if (countdown <= 0) {
                                clearInterval(timer);
                                confirmButton.disabled = true; // Vô hiệu hóa nút "Xác nhận mã OTP"
                                countdownElement.textContent = 'Hết thời gian nhập mã OTP.';
                            }
                        }, 1000);
                    }

                    let resendCount = 0; // Đếm số lần nhấn "Gửi lại mã OTP"
                    let isLocked = false; // Trạng thái khóa

                    function resendOtp() {
                        const resendButton = document.querySelector('.resend-btn');

                        if (isLocked) {
                            alert('Bạn đã bị khóa. Vui lòng thử lại sau 10 phút.');
                            return;
                        }

                        resendCount++;
                        if (resendCount > 5) {
                            isLocked = true;
                            resendButton.disabled = true; // Vô hiệu hóa nút
                            alert('Bạn đã gửi lại mã OTP quá 5 lần. Vui lòng thử lại sau 10 phút.');

                            // Khóa trong 10 phút
                            setTimeout(() => {
                                isLocked = false;
                                resendCount = 0; // Reset số lần nhấn
                                resendButton.disabled = false; // Bật lại nút
                            }, 10 * 60 * 1000); // 10 phút
                        } else {
                            alert(`Mã OTP mới đã được gửi đến email của bạn. Bạn còn ${5 - resendCount} lần gửi lại.`);

                            // Reset và bắt đầu lại đếm ngược
                            startCountdown();
                        }
                    }

                    function validateEmail() {
                        const emailInput = document.getElementById('email');
                        const sendButton = document.getElementById('sendButton');
                        const emailError = document.getElementById('emailError');
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Định dạng email cơ bản

                        if (emailInput.value === "") {
                            emailError.textContent = "Vui lòng nhập email.";
                            emailError.style.display = "block"; // Hiển thị thông báo lỗi
                            sendButton.disabled = true; // Tắt nút nếu chưa nhập email
                        } else if (!emailRegex.test(emailInput.value)) {
                            emailError.textContent = "Vui lòng nhập đúng định dạng email.";
                            emailError.style.display = "block"; // Hiển thị thông báo lỗi
                            sendButton.disabled = true; // Tắt nút nếu email không hợp lệ
                        } else {
                            emailError.style.display = "none"; // Ẩn thông báo lỗi nếu email hợp lệ
                            sendButton.disabled = false; // Bật nút nếu email hợp lệ
                        }
                    }
                </script>      
            </div>
        </div>
    </div>
</body>
</html>
``` 